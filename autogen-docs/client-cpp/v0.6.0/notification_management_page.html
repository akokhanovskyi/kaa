<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>client-cpp: Notification management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">client-cpp
   &#160;<span id="projectnumber">0.0.1-SNAPSHOT</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('notification_management_page.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Notification management </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="brief"></a>
Brief description</h1>
<p>The Kaa Notifications subsystem enables messages delivery from the Kaa cluster to endpoints (EP). It is based on auto-generated classes according to the topic's notification schema used during SDK generation.</p>
<p>Notification topics can be mandatory or voluntary. Mandatory topic notifications are delivered in an enforced manner. Voluntary topics require subscription. It is the responsibility of the client code to register the topic update listener and subscribe to voluntary topics.</p>
<h1><a class="anchor" id="topics"></a>
Topics - usage examples</h1>
<h2><a class="anchor" id="retrieving_topic_list"></a>
Getting access to the current topic list</h2>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span>kaa;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Kaa initialization</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="classkaa_1_1IKaaClient.html">IKaaClient</a>&amp; kaaClient = <a class="code" href="classkaa_1_1Kaa.html#a43b389d718eae08dd7a7e6cea7f80e24">Kaa::getKaaClient</a>();</div>
<div class="line"><a class="code" href="classkaa_1_1INotificationManager.html">INotificationManager</a>&amp; notificationManager = kaaClient.getNotificationManager();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; topics = notificationManager.<a class="code" href="classkaa_1_1INotificationManager.html#a8af0a36448d36400afe5e535de299fa5">getTopics</a>();</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> it : topics) {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Id: &quot;</span> &lt;&lt; it.first &lt;&lt; <span class="stringliteral">&quot;, name: &quot;</span> &lt;&lt; it.second.name</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;, type: &quot;</span> &lt;&lt; <a class="code" href="classkaa_1_1LoggingUtils.html#a7f91b8ea253c55ffe1f18778105e4177">LoggingUtils::TopicSubscriptionTypeToString</a>(</div>
<div class="line">                      it.second.subscriptionType) &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="topic_update_subscription"></a>
Topic update subscription</h2>
<p>If there is need to know about topic list updates, do following: </p><div class="fragment"><div class="line"><span class="keyword">class </span>BasicTopicUpdateListener : <span class="keyword">public</span> INotificationTopicsListener {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// Will be called on each update of the topic list </span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onListUpdated(<span class="keyword">const</span> <a class="code" href="namespacekaa.html#ace8f21908a0ed3446b7dcc9f93a7462f">Topics</a>&amp; newList) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> topic : newList) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Id: &quot;</span> &lt;&lt; topic.id &lt;&lt; <span class="stringliteral">&quot;, name: &quot;</span> &lt;&lt; topic.name</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot;, type: &quot;</span> &lt;&lt; LoggingUtils::TopicSubscriptionTypeToString(</div>
<div class="line">                              topic.subscriptionType) &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line">...</div>
<div class="line"><span class="comment">// Create and subscribe listener for topic list updates</span></div>
<div class="line">std::unique_ptr&lt;INotificationTopicsListener&gt; topicUpdateListener(<span class="keyword">new</span> BasicTopicUpdateListener);</div>
<div class="line">notificationManager.addTopicsListener(topicUpdateListener.get());</div>
<div class="line">...</div>
<div class="line"><span class="comment">// Remove topic update listener</span></div>
<div class="line">notificationManager.removeTopicsListener(topicUpdateListener.get());</div>
</div><!-- fragment --><h1><a class="anchor" id="notifications"></a>
Notifications - usage examples</h1>
<p>In order to receive notifications, both mandatory or voluntary, there should be add an appropriate listener. The listener may be one for all topics. Also there is possibility to add listener for specific topic notifications.</p>
<p>Assume, notification schema has the following form: </p><div class="fragment"><div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;type&quot;</span>: <span class="stringliteral">&quot;record&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;name&quot;</span>: <span class="stringliteral">&quot;BasicNotification&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;namespace&quot;</span>: <span class="stringliteral">&quot;org.kaaproject.kaa.client.example&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;fields&quot;</span>: [</div>
<div class="line">        {</div>
<div class="line">            <span class="stringliteral">&quot;name&quot;</span>: <span class="stringliteral">&quot;body&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;type&quot;</span>: <span class="stringliteral">&quot;string&quot;</span></div>
<div class="line">        }</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>After calling avrogen.sh script Avro C++ compiler will be generated appropriate code and put it into NotificationGen.hpp header. So auto-generated notification class will be like: </p><div class="fragment"><div class="line"><span class="keyword">struct </span>BasicNotification {</div>
<div class="line">    std::string body;</div>
<div class="line">};</div>
</div><!-- fragment --><p>As mentioned earlier, there is two kind of topics - mandatory and voluntary. Further it will be discussed dealing with both of them.</p>
<h2><a class="anchor" id="global_mandatory_listeners"></a>
Global listener(s) for mandatory topics</h2>
<p>Below is an example for receiving notifications for all mandatory topics: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;kaa/gen/NotificationGen.hpp&quot;</span> <span class="comment">// auto-generated header</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>BasicNotificationListener : <span class="keyword">public</span> AbstractNotificationListener&lt;BasicNotification&gt; {</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onNotification(<span class="keyword">const</span> std::string&amp; <span class="keywordtype">id</span>, <span class="keyword">const</span> BasicNotification&amp; notification) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Received notification with body: &quot;</span> &lt;&lt; notification.body &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line">...</div>
<div class="line">std::unique_ptr&lt;INotificationListener&gt; mandatoryTopicListener(<span class="keyword">new</span> BasicNotificationListener);</div>
<div class="line">notificationManager.addMandatoryTopicsListener(mandatoryTopicListener.get());</div>
</div><!-- fragment --><h2><a class="anchor" id="specific_listener"></a>
Specific listener(s) for mandatory topic</h2>
<p>To add specific listener(s) for some mandatory topic do following: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;kaa/gen/NotificationGen.hpp&quot;</span> <span class="comment">// auto-generated header</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>WheatherNotificationListener : <span class="keyword">public</span> AbstractNotificationListener&lt;Topic&gt; {</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onNotification(<span class="keyword">const</span> std::string&amp; <span class="keywordtype">id</span>, <span class="keyword">const</span> BasicNotification&amp; notification) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;What&#39;s weather: &quot;</span> &lt;&lt; notification.body &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>NewsNotificationListener : <span class="keyword">public</span> AbstractNotificationListener&lt;BasicNotification&gt; {</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onNotification(<span class="keyword">const</span> std::string&amp; <span class="keywordtype">id</span>, <span class="keyword">const</span> BasicNotification&amp; notification) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;What&#39;s news: &quot;</span> &lt;&lt; notification.body &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Add specific listeners both for news and weather topics</span></div>
<div class="line">std::unique_ptr&lt;INotificationListener&gt; weatherTopicListener(<span class="keyword">new</span> WheatherNotificationListener);</div>
<div class="line">std::unique_ptr&lt;INotificationListener&gt; newsTopicListener(<span class="keyword">new</span> NewsNotificationListener);</div>
<div class="line"></div>
<div class="line">TopicSubscriberInfo wI;</div>
<div class="line">wI.action_ = TopicSubscriberInfo::ADD;</div>
<div class="line">wI.lisnener_ = weatherTopicListener.get();</div>
<div class="line"></div>
<div class="line">TopicSubscriberInfo nI;</div>
<div class="line">nI.action_ = TopicSubscriberInfo::ADD;</div>
<div class="line">nI.lisnener_ = newsTopicListener.get();</div>
<div class="line"></div>
<div class="line"><a class="code" href="namespacekaa.html#a6140c2fbc0fbf04c7f159d655f63ac4f">TopicSubscribers</a> subscriptionInfo({{<span class="stringliteral">&quot;wheather_topic_id&quot;</span>, wI}, {<span class="stringliteral">&quot;news_topic_id&quot;</span>, nI}});</div>
<div class="line">notificationManager.updateTopicSubscriptions(subscriptionInfo);</div>
</div><!-- fragment --><h2><a class="anchor" id="removal_listeners_for_mandatory_topics"></a>
Removal of listeners for mandatory topics</h2>
<p>Removal of the global listener for mandatory topics </p><div class="fragment"><div class="line">notificationManager.removeMandatoryTopicsListener(mandatoryTopicListener.get());</div>
</div><!-- fragment --><p>Removal of the specific listener for some mandatory topic </p><div class="fragment"><div class="line">TopicSubscriberInfo nI;</div>
<div class="line">nI.action_ = TopicSubscriberInfo::REMOVE;</div>
<div class="line">nI.lisnener_ = newsTopicListener.get();</div>
<div class="line"><a class="code" href="namespacekaa.html#a6140c2fbc0fbf04c7f159d655f63ac4f">TopicSubscribers</a> subscriptionInfo({{<span class="stringliteral">&quot;news_topic_id&quot;</span>, nI}});</div>
<div class="line">notificationManager.updateTopicSubscriptions(subscriptionInfo);</div>
</div><!-- fragment --><h2><a class="anchor" id="voluntary_topics"></a>
Voluntary topic (un)subscription</h2>
<p>To receive notifications for some voluntary topic, firstly you should subscribe for it. Steps are equal to <a class="el" href="notification_management_page.html#specific_listener">Specific listener(s) for mandatory topic</a>. If there is no need in a subscription for some voluntary topic, repeat steps <a class="el" href="notification_management_page.html#removal_listeners_for_mandatory_topics">Removal of listeners for mandatory topics</a>.</p>
<p><b>NOTE: If there is need to subscribe/unsubscribe for/from a several voluntary topic, please, do it at ONCE. Such approach helps to reduce number of connection to the Operation server, improve framework performance and avoid possible race conditions.</b></p>
<p>Below there is an example describing the true way of dealing with voluntary topics: </p><div class="fragment"><div class="line"><span class="keyword">class </span>FirstVoluntaryNotificationListener : <span class="keyword">public</span> AbstractNotificationListener&lt;Topic&gt; {</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onNotification(<span class="keyword">const</span> std::string&amp; <span class="keywordtype">id</span>, <span class="keyword">const</span> Topic&amp; notification) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;New data: &quot;</span> &lt;&lt; notification.name &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>SecondVoluntaryNotificationListener : <span class="keyword">public</span> AbstractNotificationListener&lt;Topic&gt; {</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onNotification(<span class="keyword">const</span> std::string&amp; <span class="keywordtype">id</span>, <span class="keyword">const</span> Topic&amp; notification) {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;New data: &quot;</span> &lt;&lt; notification.name &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line">std::unique_ptr&lt;INotificationListener&gt; boringTopicVoluntaryListener(<span class="keyword">new</span> BasicNotificationListener);</div>
<div class="line"></div>
<div class="line">std::unique_ptr&lt;INotificationListener&gt; firstVoluntaryListener(<span class="keyword">new</span> FirstVoluntaryNotificationListener);</div>
<div class="line">std::unique_ptr&lt;INotificationListener&gt; secondVoluntaryListener(<span class="keyword">new</span> SecondVoluntaryNotificationListener);</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line"><span class="comment">// Subscribe for new voluntary topic</span></div>
<div class="line">TopicSubscriberInfo newVolInf;</div>
<div class="line">newVolInf.action_ = TopicSubscriberInfo::ADD;</div>
<div class="line">newVolInf.lisnener_ = firstVoluntaryListener.get();</div>
<div class="line"></div>
<div class="line"><span class="comment">// Assume there is already one voluntary subscription. Unsubscribe from it.</span></div>
<div class="line">TopicSubscriberInfo oldVolInf;</div>
<div class="line">oldVolInf.action_ = TopicSubscriberInfo::REMOVE;</div>
<div class="line">oldVolInf.lisnener_ = boringTopicVoluntaryListener.get();</div>
<div class="line"><a class="code" href="namespacekaa.html#a6140c2fbc0fbf04c7f159d655f63ac4f">TopicSubscribers</a> subscriptionInfo1({{<span class="stringliteral">&quot;boring_voluntary_topic_id&quot;</span>, oldVolInf}</div>
<div class="line">                                    , {<span class="stringliteral">&quot;new_voluntary_topic_id&quot;</span>, newVolInf}});</div>
<div class="line"></div>
<div class="line">notificationManager.updateTopicSubscriptions(subscriptionInfo1);</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line"><span class="comment">// Add new listener to &quot;new_voluntary_topic_id&quot; topic</span></div>
<div class="line">TopicSubscriberInfo newVolListenerInf;</div>
<div class="line">newVolListenerInf.action_ = TopicSubscriberInfo::ADD;</div>
<div class="line">newVolListenerInf.lisnener_ = secondVoluntaryListener.get();</div>
<div class="line"></div>
<div class="line"><a class="code" href="namespacekaa.html#a6140c2fbc0fbf04c7f159d655f63ac4f">TopicSubscribers</a> subscriptionInfo2({{<span class="stringliteral">&quot;new_voluntary_topic_id&quot;</span>, newVolListenerInf}});</div>
<div class="line"></div>
<div class="line">notificationManager.updateTopicSubscriptions(subscriptionInfo2);</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line"><span class="comment">// Remove first listener from two added before</span></div>
<div class="line">TopicSubscriberInfo removeAdditionalVolListinf;</div>
<div class="line">newVolListenerInf.action_ = TopicSubscriberInfo::REMOVE;</div>
<div class="line">newVolListenerInf.lisnener_ = firstVoluntaryListener.get();</div>
<div class="line"></div>
<div class="line"><a class="code" href="namespacekaa.html#a6140c2fbc0fbf04c7f159d655f63ac4f">TopicSubscribers</a> subscriptionInfo3({{<span class="stringliteral">&quot;new_voluntary_topic_id&quot;</span>, removeAdditionalVolListinf}});</div>
<div class="line"></div>
<div class="line">notificationManager.updateTopicSubscriptions(subscriptionInfo3);</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line"><span class="comment">// Remove second listener from two added before. If no listener exits,</span></div>
<div class="line"><span class="comment">// Kaa unsubscribes from this voluntary topic.</span></div>
<div class="line">TopicSubscriberInfo removeLastVolListinf;</div>
<div class="line">newVolListenerInf.action_ = TopicSubscriberInfo::REMOVE;</div>
<div class="line">newVolListenerInf.lisnener_ = secondVoluntaryListener.get();</div>
<div class="line"></div>
<div class="line"><a class="code" href="namespacekaa.html#a6140c2fbc0fbf04c7f159d655f63ac4f">TopicSubscribers</a> subscriptionInfo4({{<span class="stringliteral">&quot;new_voluntary_topic_id&quot;</span>, removeLastVolListinf}});</div>
<div class="line"></div>
<div class="line">notificationManager.updateTopicSubscriptions(subscriptionInfo4);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Kaa client C++ sdk</a></li>
    <li class="footer">Generated on Fri Oct 17 2014 17:43:34 for client-cpp by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.7 </li>
  </ul>
</div>
</body>
</html>
